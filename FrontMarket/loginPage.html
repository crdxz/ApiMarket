<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Marketplace Login</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<style type="text/tailwindcss">
      :root {
        --primary-color: #0c7ff2;
        --background-color: #f9f9f9;
        --text-primary: #111418;
        --text-secondary: #637488;
        --accent-color: #e0e7ff;
      }
      body {
        font-family: 'Inter', sans-serif;
        background-color: var(--background-color);
        color: var(--text-primary);
      }
      .button_primary {
        @apply bg-[var(--primary-color)] text-white rounded-md px-4 py-2 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50;
      }
      .input {
        @apply bg-white border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
      }
      .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 400px;
        text-align: center;
      }
    </style>
</head>
<body>
<!-- Modal de Error -->
<div id="errorModal" class="modal">
  <div class="modal-content">
    <div class="flex items-center justify-center mb-4">
      <svg class="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
    </div>
    <h3 class="text-lg font-semibold text-gray-900 mb-2">Error de Inicio de Sesión</h3>
    <p id="errorMessage" class="text-gray-600 mb-4">Ha ocurrido un error al iniciar sesión.</p>
    <button onclick="closeErrorModal()" class="button_primary w-full">Cerrar</button>
  </div>
</div>

<div class="flex items-center justify-center min-h-screen bg-[var(--background-color)]">
<div class="w-full max-w-md p-8 space-y-8 bg-white rounded-lg shadow-lg">
<div class="text-center">
<h1 class="text-3xl font-bold text-[var(--text-primary)]">Welcome Back</h1>
<p class="mt-2 text-base text-[var(--text-secondary)]">Log in to continue to Marketplace</p>
</div>
<form id="loginForm" class="mt-8 space-y-6">
<div class="rounded-md shadow-sm -space-y-px">
<div class="mb-4">
<label class="sr-only" for="email-address">Email address</label>
<input autocomplete="email" class="input relative block w-full px-3 py-3 placeholder-gray-500 border-gray-300 rounded-md appearance-none focus:outline-none focus:ring-primary focus:border-primary focus:z-10 sm:text-sm" id="email-address" name="email" placeholder="Email address or phone number" required="" type="email"/>
</div>
<div class="mb-4">
<label class="sr-only" for="password">Password</label>
<input autocomplete="current-password" class="input relative block w-full px-3 py-3 placeholder-gray-500 border-gray-300 rounded-md appearance-none focus:outline-none focus:ring-primary focus:border-primary focus:z-10 sm:text-sm" id="password" name="password" placeholder="Password" required="" type="password"/>
</div>
</div>
<div class="flex items-center justify-between">
<div class="text-sm">
<a class="font-medium text-[var(--primary-color)] hover:text-blue-500" href="#"> Forgot your password? </a>
</div>
</div>
<div>
<button id="loginButton" class="group relative flex justify-center w-full px-4 py-3 text-sm font-medium text-white bg-[var(--primary-color)] border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary" type="submit">
              <span id="loginButtonText">Log In</span>
              <span id="loginButtonSpinner" class="hidden">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </span>
            </button>
</div>
</form>
<div class="relative">
<div class="absolute inset-0 flex items-center">
<div class="w-full border-t border-gray-300"></div>
</div>
<div class="relative flex justify-center text-sm">
<span class="px-2 bg-white text-[var(--text-secondary)]"> Or </span>
</div>
</div>
<div>
<p class="mt-2 text-sm text-center text-[var(--text-secondary)]">
            New to Marketplace?
            <a class="font-medium text-[var(--primary-color)] hover:text-blue-500" href="#"> Create an account </a>
</p>
</div>
</div>
</div>

<script>
// Configuración de la API
const API_BASE_URL = 'http://localhost:5000/api';

// Elementos del DOM
const loginForm = document.getElementById('loginForm');
const loginButton = document.getElementById('loginButton');
const loginButtonText = document.getElementById('loginButtonText');
const loginButtonSpinner = document.getElementById('loginButtonSpinner');
const errorModal = document.getElementById('errorModal');
const errorMessage = document.getElementById('errorMessage');

// Función para mostrar el modal de error
function showErrorModal(message) {
    errorMessage.textContent = message;
    errorModal.style.display = 'block';
}

// Función para cerrar el modal de error
function closeErrorModal() {
    errorModal.style.display = 'none';
}

// Función para mostrar/ocultar el spinner de carga
function setLoading(loading) {
    if (loading) {
        loginButton.disabled = true;
        loginButtonText.style.display = 'none';
        loginButtonSpinner.classList.remove('hidden');
    } else {
        loginButton.disabled = false;
        loginButtonText.style.display = 'inline';
        loginButtonSpinner.classList.add('hidden');
    }
}

// Función para hacer login
async function loginUser(email, password) {
    try {
        const response = await fetch(`${API_BASE_URL}/users/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: email,
                password: password
            })
        });

        const data = await response.json();

        if (response.ok) {
            // Login exitoso
            console.log('Login exitoso:', data);
            
            // Guardar información del usuario en localStorage
            localStorage.setItem('user', JSON.stringify(data.user));
            localStorage.setItem('isLoggedIn', 'true');
            
            // Redirigir según el tipo de usuario
            if (data.user.user_type === 'seller') {
                window.location.href = 'dashboardSellerPahe.html';
            } else {
                window.location.href = 'mainPage.html';
            }
        } else {
            // Error en el login
            throw new Error(data.error || 'Error al iniciar sesión');
        }
    } catch (error) {
        console.error('Error en login:', error);
        throw error;
    }
}

// Event listener para el formulario
loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('email-address').value;
    const password = document.getElementById('password').value;
    
    // Validación básica
    if (!email || !password) {
        showErrorModal('Por favor, completa todos los campos.');
        return;
    }
    
    // Mostrar spinner de carga
    setLoading(true);
    
    try {
        await loginUser(email, password);
    } catch (error) {
        // Mostrar error en el modal
        showErrorModal(error.message || 'Error al conectar con el servidor. Verifica que la API esté ejecutándose.');
    } finally {
        // Ocultar spinner de carga
        setLoading(false);
    }
});

// Cerrar modal al hacer clic fuera de él
window.onclick = function(event) {
    if (event.target === errorModal) {
        closeErrorModal();
    }
}

// Verificar si ya está logueado al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    const isLoggedIn = localStorage.getItem('isLoggedIn');
    if (isLoggedIn === 'true') {
        // Si ya está logueado, redirigir a mainPage
        window.location.href = 'mainPage.html';
    }
});
</script>

</body></html>